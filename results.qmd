# Results

Outline

How has the number of rat sighting reports changed over time?- overall times series
  How does this differ across boroughs?- time series faceted by borough
  How does this differ across location type?- time series faceted by location type (and bar chart to see most common location types)
  
Where is the rat problem the worst?
  Which areas of NYC?- density map
    How has this changed over time?- maybe d3 graph with button/slider to choose year. then make same graph with data from that year only
  Which locations?- density map faceted by location type (consider that this might be influenced by differences in location types across different areas of the city)
  
What affects the status of a 311 rat sighting request?- mosaic plot with borough, year range, location type;  dependendent = status (and bar chart to see most common statuses)


```{r}
library(ggplot2)
library(dplyr)
library(scales)
library(forcats)
library(ggmap)
library(sf)
library(readxl)
library(tmap)
library(vcd)

df <- read.csv("/Users/kaitlynbrown/Desktop/STAT5702/Rat_Sightings.csv")
df<- mutate(df, Created.Date = as.Date(Created.Date, format = "%m-%d-%Y"))

ggplot(df, aes(Created.Date)) +
    geom_bar(stat="count", na.rm = TRUE) +
    ggtitle("Rat Sightings per Day") +
    xlab("Date") + ylab("Number of Sightings") +
    scale_x_date(labels=date_format ("%m-%d-%Y"))

df2 <- df[df$Borough != "Unspecified",]
df2 <- df2[df2$Borough != "",]
ggplot(df2, aes(Created.Date)) +
    geom_bar(stat="count", na.rm = TRUE) +
    ggtitle("Rat Sightings per Day by Borough") +
    xlab("Date") + ylab("Number of Sightings") +
    scale_x_date(labels=date_format ("%m-%d-%Y")) +
    facet_wrap(~Borough)

ggplot(df, aes(fct_infreq(Location.Type))) +
    geom_bar(stat="count", na.rm = TRUE) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

locations = list("3+ Family Mixed Use Building", "3+ Family Apt. Building", "1-2 Family Dwelling", "1-2 Family Mixed Use Building", "Commercial Building")

df3 <- df[df$Location.Type %in% locations,]
ggplot(df3, aes(Created.Date)) +
    geom_bar(stat="count", na.rm = TRUE) +
    ggtitle("Rat Sightings per Day by Borough") +
    xlab("Date") + ylab("Number of Sightings") +
    scale_x_date(labels=date_format ("%m-%d-%Y")) +
    facet_wrap(~Location.Type)

nyc_map <- get_stadiamap(bbox = c(left = -74.2591, bottom = 40.4774, 
                                 right = -73.7002, top = 40.9162),
                        zoom = 10, maptype = "stamen_toner_lite")

df_sample = sample_n(df, nrow(df)/10)

ggmap(nyc_map) +
  geom_point(data = df_sample, aes(x=Longitude,y=Latitude), size = 0.01, color = 'red')

zipcodes = st_read('/Users/kaitlynbrown/Desktop/STAT5702/nyc.shp',quiet=TRUE)

zipcodes <- zipcodes %>% 
       rename(Incident.Zip = 'modzcta')

df4 <- df %>% group_by(Incident.Zip) %>% 
  summarise(total_count=n(),
            .groups = 'drop')

map_df <- left_join(zipcodes, df4)

tm_shape(map_df) + 
  tm_polygons("total_count", id = 'Incident Zip', palette = "Blues", title="") + 
  tm_facets(by= "") +
  tm_layout("Rat Sightings from 2010-2023 by Zip Code",
            title.size = .95, frame = FALSE)

df5 <- df3 %>% group_by(Incident.Zip, Location.Type) %>% 
  summarise(total_count=n(),
            .groups = 'drop')

df6 <- df3 %>% group_by(Location.Type) %>% 
  summarise(total_count_loc=n(),
            .groups = 'drop')

df5 <- left_join(df5,df6)
df5$total_count <- df5$total_count / df5$total_count_loc
df5

map_df2 <- left_join(zipcodes, df5)

tm_shape(map_df2) + 
  tm_polygons("total_count", id = 'Incident Zip', palette = "Blues", title="") + 
  tm_facets(by= 'Location.Type') +
  tm_layout("Percentage of Rat Sightings from 2010-2023 in each Zip Code by Location Type",
            title.size = .95, frame = FALSE)

df7 <- mutate(df3, Year.Range = case_when(
    Created.Date < as.Date("01-01-2014", format = "%m-%d-%Y") ~ "2010-2013",
    Created.Date < as.Date("01-01-2018", format = "%m-%d-%Y") & Created.Date >= as.Date("01-01-2014", format = "%m-%d-%Y") ~ "2014-2017",
    Created.Date < as.Date("01-01-2022", format = "%m-%d-%Y") & Created.Date >= as.Date("01-01-2018", format = "%m-%d-%Y") ~ "2018-2021",
    Created.Date >= as.Date("01-01-2022", format = "%m-%d-%Y") ~ "2022-2023"
    ))

ggplot(df7, aes(fct_infreq(Status))) +
    geom_bar(stat="count", na.rm = TRUE) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

df7 <- mutate(df7, Status = case_when(
    Status == "Closed" ~ "Closed",
    Status == "Pending" ~ "Not Closed",
    Status == "Assigned" ~ "Not Closed",
    Status == "In Progress" ~ "Not Closed",
    Status == "Open" ~ "Not Closed",
    Status == "Unspecified" ~ "Not Closed"))

df7 <- df7[df7$Borough != 'STATEN ISLAND',]
df7 <- df7[df7$Borough != 'Unspecified',]
df7 <- df7[df7$Location.Type != '3+ Family Mixed Use Building',]
df7 <- df7[df7$Location.Type != '1-2 Family Mixed Use Building',]

vcd::mosaic(Status ~ Borough + Year.Range, data = df7, direction = c('v','v','h'), highlighting_fill = c('green','red'), main = 'Status of Rat Sighting 311 Requests', labeling = vcd::labeling_border(rot_labels = c(45, 45)))

vcd::mosaic(Status ~ Location.Type + Year.Range, data = df7, direction = c('v','v','h'), highlighting_fill = c('green','red'), main = 'Status of Rat Sighting 311 Requests', labeling = vcd::labeling_border(rot_labels = c(45, 45)))
```

```{r}

```
